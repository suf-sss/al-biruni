<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Requests | AL-BIRUNI</title>
  <link rel="icon" href="images/icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    .access-denied-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .access-denied-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      max-width: 90%;
      width: 400px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* أضف هذه الأنماط في نهاية ملف CSS أو في وسم style */
    .deleting .loading-icon {
      opacity: 1 !important;
    }
    .deleting span:first-child {
      opacity: 0;
    }
    .success .success-icon {
      opacity: 1 !important;
    }
    .success span:first-child,
    .success .loading-icon {
      opacity: 0;
    }

    #delete-confirm-modal.scale-0 {
      opacity: 0;
    }
    #delete-confirm-modal.scale-100 {
      opacity: 1;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <script>
    if (!localStorage.getItem('isLoggedIn')) {
      document.body.innerHTML = `
        <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f3f4f6;">
          <div style="background:white;padding:2.5rem 2rem;border-radius:1.2rem;box-shadow:0 4px 24px #0001;text-align:center;max-width:90vw;">
            <div style="font-size:2.5rem;color:#ef4444;margin-bottom:1rem;">
              <i style='font-size:2.5rem;' class='fa fa-ban'></i>
            </div>
            <div style="font-size:1.3rem;font-weight:600;color:#1e293b;margin-bottom:0.5rem;">Access Denied</div>
            <div style="color:#64748b;margin-bottom:1.5rem;">You are not authorized to access this page.<br>Please login first.</div>
            <a href="/login" style="display:inline-block;background:#2563eb;color:white;padding:0.7rem 2.2rem;border-radius:2rem;font-weight:600;text-decoration:none;box-shadow:0 2px 8px #2563eb22;">Go to Login</a>
          </div>
        </div>
      `;
      setTimeout(() => { window.location.href = '/'; }, 2200);
    }

    // منع دخول nor لهذه الصفحة
    if (localStorage.getItem('userRole') === 'nor') {
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.background = 'rgb(231 231 231)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '99999';
      modal.innerHTML = `
        <div style="background:white;padding:2.5rem 2rem;border-radius:1.2rem;box-shadow:0 4px 24px #0001;text-align:center;max-width:90vw;min-width:320px;">
          <div style="font-size:2.5rem;color:#ef4444;margin-bottom:1rem;">
            <i style='font-size:2.5rem;' class='fa fa-ban'></i>
          </div>
          <div style="font-size:1.3rem;font-weight:600;color:#1e293b;margin-bottom:0.5rem;">Access Denied</div>
          <div style="color:#64748b;margin-bottom:1.5rem;">You are not authorized to access this page.<br>Please get permission from admin SUFYAN.</div>
          <a href="/admin" style="display:inline-block;background:#2563eb;color:white;padding:0.7rem 2.2rem;border-radius:2rem;font-weight:600;text-decoration:none;box-shadow:0 2px 8px #2563eb22;">Back to Dashboard</a>
        </div>
      `;
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }
        function updateOwnLastActive(isOnline = true) {
      const teacherData = localStorage.getItem('teacherData');
      if (teacherData) {
        try {
          const t = JSON.parse(teacherData);
          if (t && t.name) {
            db.collection('teachers')
              .where('name', '==', t.name)
              .limit(1)
              .get()
              .then(snapshot => {
                if (!snapshot.empty) {
                  const docId = snapshot.docs[0].id;
                  // إذا خرج من الصفحة، اجعل lastActive = 0 (أوفلاين فوري)
                  db.collection('teachers').doc(docId).update({ lastActive: isOnline ? Date.now() : 0 });
                }
              });
          }
        } catch {}
      }
    }
    // حدث lastActive عند تحميل الصفحة وكل دقيقة، وعند الخروج من الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      updateOwnLastActive(true);
      setInterval(() => updateOwnLastActive(true), 60 * 1000);
      // عند الخروج أو إغلاق الصفحة، اجعل المعلم أوفلاين فوراً
      window.addEventListener('beforeunload', function() {
        updateOwnLastActive(false);
      });
      // عند فقدان التركيز (مثلاً غلق التبويب)، اجعل أوفلاين
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
          updateOwnLastActive(false);
        } else if (document.visibilityState === 'visible') {
          updateOwnLastActive(true);
        }
      });
    });
  </script>
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
      <div class="flex flex-col sm:flex-row items-center justify-between h-auto sm:h-16 gap-2 sm:gap-0 py-2 sm:py-0">
        <div class="flex items-center space-x-2 sm:space-x-4">
          <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Requests</h1>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
          <a href="/admin" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-bold text-center">
            Back to Admin Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
    <!-- Stats Card -->
    <div class="mb-8">
      <div class="bg-white rounded-lg shadow p-4 sm:p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-blue-100 rounded-lg p-4 text-center">
            <span class="text-2xl font-bold text-blue-700" id="total-requests">0</span>
            <p class="text-sm text-blue-600">Total Requests</p>
          </div>
          <div class="bg-green-100 rounded-lg p-4 text-center">
            <span class="text-2xl font-bold text-green-700" id="accepted-count">0</span>
            <p class="text-sm text-green-600">Accepted</p>
          </div>
          <div class="bg-red-100 rounded-lg p-4 text-center">
            <span class="text-2xl font-bold text-red-700" id="pending-count">0</span>
            <p class="text-sm text-red-600">Pending</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Requests Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-2 sm:px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-2">
        <h3 class="text-base sm:text-lg font-medium text-gray-900">
          Registration Requests (<span id="visible-requests">0</span>)
        </h3>
      </div>
      <div class="overflow-x-auto">
        <div style="max-height: 600px; overflow-y: auto;">
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50">Student Info</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50">Parent Info</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50">Actions</th>
              </tr>
            </thead>
            <tbody id="requests-tbody" class="bg-white divide-y divide-gray-200">
              <!-- Will be filled by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Messages Section -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-lg font-semibold mb-4">Messages</h2>
      <div id="messages-container" class="space-y-4">
        <!-- Messages will be loaded here dynamically -->
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div id="view-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
      <button onclick="closeViewModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-blue-700">Student Registration Details</h2>
      <div id="view-modal-content" class="space-y-4">
        <!-- Will be filled by JS -->
      </div>
    </div>
  </div>

  <!-- تحديث Modal تأكيد الحذف -->
  <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 transform scale-0 transition-transform duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative transform transition-all">
      <div class="text-center">
        <!-- أيقونة الحذف المتحركة -->
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100 mb-6">
          <svg class="animate-pulse h-12 w-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Confirm Deletion</h3>
        <p class="text-gray-600 mb-8">Are you sure you want to delete this registration request? This action cannot be undone.</p>
        
        <div class="flex justify-center space-x-4">
          <button id="cancel-delete" 
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transform hover:scale-105 transition-all duration-300 font-medium">
            Cancel
          </button>
          <button id="confirm-delete" 
            class="group relative px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transform hover:scale-105 transition-all duration-300 font-medium overflow-hidden">
            <span class="relative z-10 group-hover:opacity-0 transition-opacity duration-300">Delete Request</span>
            <span class="loading-icon absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <svg class="animate-spin -ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Deleting...
            </span>
            <span class="success-icon absolute inset-0 flex items-center justify-center opacity-0">
              <svg class="w-6 h-6 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Deleted!
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- إضافة modal تأكيد حذف الرسالة -->
  <div id="delete-message-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 transform scale-0 transition-transform duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative transform transition-all">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100 mb-6">
                <svg class="animate-pulse h-12 w-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Delete Message</h3>
            <p class="text-gray-600 mb-8">Are you sure you want to delete this message? This action cannot be undone.</p>
            
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-message" 
                    class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transform hover:scale-105 transition-all duration-300 font-medium">
                    Cancel
                </button>
                <button id="confirm-delete-message" 
                    class="group relative px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transform hover:scale-105 transition-all duration-300 font-medium overflow-hidden">
                    <span class="relative z-10">Delete Message</span>
                    <span class="loading-icon absolute inset-0 flex items-center justify-center opacity-0">
                        <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCE-N0QQmjLie60yBSRe7rl6ulfb7YbwqU",
      authDomain: "al-biruni.firebaseapp.com",
      projectId: "al-biruni",
      storageBucket: "al-biruni.appspot.com",
      messagingSenderId: "77152769570",
      appId: "1:77152769570:web:83b8de7bd64856d7f51c7b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let registrationRequests = [];

    // Load registration requests
    async function loadRequests() {
      try {
        const snapshot = await db.collection('registrationRequests')
          .orderBy('date', 'desc')
          .get();

        registrationRequests = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        updateStats();
        renderRequests();
      } catch (error) {
        console.error('Error loading requests:', error);
        document.getElementById('requests-tbody').innerHTML = `
          <tr><td colspan="5" class="text-center text-red-500 py-4">
            Error loading requests. Please try again.
          </td></tr>
        `;
      }
    }

    // Update statistics
    function updateStats() {
      const total = registrationRequests.length;
      const accepted = registrationRequests.filter(r => r.status === 'accepted').length;
      const pending = registrationRequests.filter(r => r.status === 'pending').length;

      document.getElementById('total-requests').textContent = total;
      document.getElementById('accepted-count').textContent = accepted;
      document.getElementById('pending-count').textContent = pending;
      document.getElementById('visible-requests').textContent = total;
    }

    // Accept registration request
    async function acceptRequest(requestId) {
      try {
        const request = registrationRequests.find(r => r.id === requestId);
        if (!request) {
          alert('Request not found.');
          return;
        }

        // التحقق من وجود جميع الحقول المطلوبة
        const studentData = {
          name: request.studentName || 'Unknown Name',
          gender: request.gender || 'Unknown Gender',
          parent: request.parentName || 'Unknown Parent',
          phone: request.phone || 'Unknown Phone',
          email: request.email || 'Unknown Email',
          grade: request.grade || 'Unknown Grade',
          date: new Date().toISOString().split('T')[0]
        };

        // إضافة بيانات الطالب إلى مجموعة الطلاب
        await db.collection('students').add(studentData);

        // تحديث حالة الطلب إلى "accepted"
        await db.collection('registrationRequests').doc(requestId).update({ status: 'accepted' });

        // إعادة تحميل الطلبات لتحديث الجدول
        await loadRequests();
        alert('Student data successfully transferred to Admin Dashboard.');
      } catch (error) {
        console.error('Error transferring student data:', error);
        alert('Failed to transfer student data. Please try again.');
      }
    }

    // Reject registration request
    async function rejectRequest(requestId) {
      if (confirm('Are you sure you want to reject this request?')) {
        try {
          await db.collection('registrationRequests')
            .doc(requestId)
            .delete();
          await loadRequests();
        } catch (error) {
          console.error('Error rejecting request:', error);
          alert('Error rejecting request. Please try again.');
        }
      }
    }

    // Delete registration request
    function deleteRequestOnly(requestId) {
      const confirmationModal = document.createElement('div');
      confirmationModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40';
      confirmationModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Delete Request</h3>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this request? This action cannot be undone.</p>
          <div class="flex justify-end space-x-4">
            <button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition font-bold" onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)">Cancel</button>
            <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-bold" onclick="confirmDelete('${requestId}', this)">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmationModal);
    }

    function confirmDelete(requestId, button) {
      button.innerHTML = `<span class="animate-spin">⏳</span> Deleting...`;
      db.collection('registrationRequests')
        .doc(requestId)
        .delete()
        .then(() => {
          alert('Request deleted successfully.');
          document.body.removeChild(button.parentElement.parentElement.parentElement);
          loadRequests(); // إعادة تحميل الطلبات لتحديث القائمة
        })
        .catch(error => {
          console.error('Error deleting request:', error);
          alert('Failed to delete the request. Please try again.');
        });
    }

    // Render requests table
    function renderRequests() {
      const tbody = document.getElementById('requests-tbody');
      tbody.innerHTML = '';

      if (registrationRequests.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-4">
              No registration requests found.
            </td>
          </tr>
        `;
        return;
      }

      registrationRequests.forEach(request => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${request.studentName || 'Unknown Name'}</div>
            <div class="text-sm text-gray-500">${request.gender || 'Unknown Gender'}</div>
            <div class="text-sm text-gray-500">${request.grade || 'Unknown Grade'}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${request.parentName || 'Unknown Parent'}</div>
            <div class="text-sm text-gray-500">${request.phone || 'Unknown Phone'}</div>
            <div class="text-sm text-gray-500">${request.email || 'Unknown Email'}</div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500">
            ${request.date || 'Unknown Date'}
          </td>
          <td class="px-6 py-4">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
              ${request.status === 'accepted' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${request.status || 'Unknown Status'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex flex-col sm:flex-row gap-2">
              <button onclick="viewRequest('${request.id}')" 
                class="w-full sm:w-auto bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i>
                <span>View</span>
              </button>
              <button onclick="editRequest('${request.id}')" 
                class="w-full sm:w-auto bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center justify-center gap-2">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
              </button>
              <button onclick="deleteRequest('${request.id}')" 
                class="w-full sm:w-auto bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
              </button>
              <button onclick="addToAdminDashboard('${request.id}')" 
                class="w-full sm:w-auto bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-user-plus"></i>
                <span>Add to Admin</span>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function sendToAdmin(requestId) {
      const request = registrationRequests.find(r => r.id === requestId);
      if (!request) return;

      const adminData = {
        studentName: request.studentName,
        gender: request.gender,
        grade: request.grade,
        parentName: request.parentName,
        phone: request.phone,
        email: request.email,
        date: request.date
      };

      db.collection('students').add(adminData)
        .then(() => {
          alert('Data sent to Admin Dashboard successfully.');
          db.collection('registrationRequests').doc(requestId).update({ status: 'accepted' });
          loadRequests();
        })
        .catch(error => {
          console.error('Error sending data to Admin Dashboard:', error);
          alert('Failed to send data to Admin Dashboard.');
        });
    }

    // إضافة دالة عرض التفاصيل
    function viewRequest(requestId) {
      const request = registrationRequests.find(r => r.id === requestId);
      if (!request) return;
      const content = document.getElementById('view-modal-content');
      content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Student Information</h3>
            <div><span class="font-semibold">Name:</span> ${request.studentName}</div>
            <div><span class="font-semibold">Gender:</span> ${request.gender}</div>
            <div><span class="font-semibold">Grade:</span> ${request.grade}</div>
            <div><span class="font-semibold">DOB:</span> ${request.dob || 'N/A'}</div>
            <div><span class="font-semibold">Previous School:</span> ${request.previousSchool || 'N/A'}</div>
          </div>
          
          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Parent Information</h3>
            <div><span class="font-semibold">Name:</span> ${request.parentName}</div>
            <div><span class="font-semibold">Phone:</span> ${request.phone}</div>
            <div><span class="font-semibold">Email:</span> ${request.email}</div>
            <div><span class="font-semibold">Relationship:</span> ${request.relationship || 'N/A'}</div>
            <div><span class="font-semibold">Occupation:</span> ${request.occupation || 'N/A'}</div>
          </div>

          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Contact Information</h3>
            <div><span class="font-semibold">Address:</span> ${request.address || 'N/A'}</div>
            <div><span class="font-semibold">City:</span> ${request.city || 'N/A'}</div>
            <div><span class="font-semibold">State:</span> ${request.state || 'N/A'}</div>
            <div><span class="font-semibold">Postal Code:</span> ${request.postalCode || 'N/A'}</div>
          </div>

          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Emergency Contact</h3>
            <div><span class="font-semibold">Name:</span> ${request.emergencyContact?.name || 'N/A'}</div>
            <div><span class="font-semibold">Phone:</span> ${request.emergencyContact?.phone || 'N/A'}</div>
            <div><span class="font-semibold">Relationship:</span> ${request.emergencyContact?.relationship || 'N/A'}</div>
          </div>

          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Medical Information</h3>
            <div><span class="font-semibold">Conditions:</span> ${request.medicalInfo?.conditions || 'N/A'}</div>
            <div><span class="font-semibold">Allergies:</span> ${request.medicalInfo?.allergies || 'N/A'}</div>
          </div>

          <div class="space-y-3">
            <h3 class="font-bold text-blue-600 border-b pb-2">Additional Notes</h3>
            <div>${request.additionalNotes || 'N/A'}</div>
          </div>
        </div>
      `;
      document.getElementById('view-modal').classList.remove('hidden');
    }

    async function addToAdminDashboard(requestId) {
      try {
        const request = registrationRequests.find(r => r.id === requestId);
        if (!request) return;

        // نقل جميع الحقول التفصيلية
        const studentData = {
          name: request.studentName,
          gender: request.gender,
          grade: request.grade,
          parent: request.parentName,
          phone: request.phone,
          email: request.email,
          date: new Date().toISOString().split('T')[0],
          dob: request.dob || "",
          previousSchool: request.previousSchool || "",
          relationship: request.relationship || "",
          occupation: request.occupation || "",
          address: request.address || "",
          city: request.city || "",
          state: request.state || "",
          postalCode: request.postalCode || "",
          emergencyContact: request.emergencyContact || {},
          medicalInfo: request.medicalInfo || {},
          additionalNotes: request.additionalNotes || ""
        };

        await db.collection('students').add(studentData);

        // تحديث حالة الطلب إلى "accepted"
        await db.collection('registrationRequests')
          .doc(requestId)
          .update({ status: 'accepted' });

        // إنشاء وإظهار رسالة النجاح
        const button = document.querySelector(`button[onclick="addToAdminDashboard('${requestId}')"]`);
        if (button) {
          button.innerHTML = `
            <span class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Added Successfully!
            </span>
          `;
          button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
          button.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        setTimeout(() => {
          closeViewModal();
          loadRequests();
        }, 2000);

      } catch (error) {
        console.error('Error adding to Admin Dashboard:', error);
        alert('Failed to add student to Admin Dashboard. Please try again.');
      }
    }

    function editRequest(requestId) {
      const request = registrationRequests.find(r => r.id === requestId);
      if (!request) return;

      const content = document.getElementById('view-modal-content');
      content.innerHTML = `
        <form id="edit-request-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Student Information</h3>
              <div>
                <label class="font-semibold">Student Name:</label>
                <input type="text" id="edit-studentName" value="${request.studentName || ''}" class="border rounded px-2 py-1 w-full" required>
              </div>
              <div>
                <label class="font-semibold">Gender:</label>
                <select id="edit-gender" class="border rounded px-2 py-1 w-full" required>
                  <option value="Male" ${request.gender === 'Male' ? 'selected' : ''}>Male</option>
                  <option value="Female" ${request.gender === 'Female' ? 'selected' : ''}>Female</option>
                </select>
              </div>
              <div>
                <label class="font-semibold">Grade:</label>
                <select id="edit-grade" class="border rounded px-2 py-1 w-full" required>
                  <option value="">Select Grade</option>
                  <option value="Nursery" ${request.grade === 'Nursery' ? 'selected' : ''}>Nursery</option>
                  <option value="Kindergarten" ${request.grade === 'Kindergarten' ? 'selected' : ''}>Kindergarten</option>
                  <option value="Prep" ${request.grade === 'Prep' ? 'selected' : ''}>Prep</option>
                  <option value="3rd" ${request.grade === '3rd' ? 'selected' : ''}>3rd</option>
                  <option value="4th" ${request.grade === '4th' ? 'selected' : ''}>4th</option>
                  <option value="5th" ${request.grade === '5th' ? 'selected' : ''}>5th</option>
                  <option value="6th" ${request.grade === '6th' ? 'selected' : ''}>6th</option>
                  <option value="7th" ${request.grade === '7th' ? 'selected' : ''}>7th</option>
                  <option value="8th" ${request.grade === '8th' ? 'selected' : ''}>8th</option>
                  <option value="9th" ${request.grade === '9th' ? 'selected' : ''}>9th</option>
                  <option value="10th" ${request.grade === '10th' ? 'selected' : ''}>10th</option>
                  <option value="1st Year (Girls only)" data-girls="1" ${request.grade === '1st Year (Girls only)' ? 'selected' : ''}>1st Year (Girls only)</option>
                  <option value="2nd Year (Girls only)" data-girls="1" ${request.grade === '2nd Year (Girls only)' ? 'selected' : ''}>2nd Year (Girls only)</option>
                  <option value="Accelerated program" ${request.grade === 'Accelerated program' ? 'selected' : ''}>Accelerated program</option>
                </select>
              </div>
              <div>
                <label class="font-semibold">DOB:</label>
                <input type="text" id="edit-dob" value="${request.dob || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">Previous School:</label>
                <input type="text" id="edit-previousSchool" value="${request.previousSchool || ''}" class="border rounded px-2 py-1 w-full">
              </div>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Parent Information</h3>
              <div>
                <label class="font-semibold">Parent Name:</label>
                <input type="text" id="edit-parentName" value="${request.parentName || ''}" class="border rounded px-2 py-1 w-full" required>
              </div>
              <div>
                <label class="font-semibold">Phone:</label>
                <input type="text" id="edit-phone" value="${request.phone || ''}" class="border rounded px-2 py-1 w-full" pattern="^03[0-9]{9}$" maxlength="11" required>
              </div>
              <div>
                <label class="font-semibold">Email:</label>
                <input type="email" id="edit-email" value="${request.email || ''}" class="border rounded px-2 py-1 w-full" pattern="^[a-zA-Z0-9._%+-]+@gmail\.com$" required>
              </div>
              <div>
                <label class="font-semibold">Relationship:</label>
                <select id="edit-relationship" class="border rounded px-2 py-1 w-full">
                  <option value="father" ${request.relationship === 'father' ? 'selected' : ''}>(Father)</option>
                  <option value="mother" ${request.relationship === 'mother' ? 'selected' : ''}>(Mother)</option>
                  <option value="brother" ${request.relationship === 'brother' ? 'selected' : ''}>(Brother)</option>
                  <option value="sister" ${request.relationship === 'sister' ? 'selected' : ''}>(Sister)</option>
                  <option value="uncle" ${request.relationship === 'uncle' ? 'selected' : ''}>(Uncle - Paternal)</option>
                  <option value="aunt" ${request.relationship === 'aunt' ? 'selected' : ''}>(Aunt - Paternal)</option>
                  <option value="maternal-uncle" ${request.relationship === 'maternal-uncle' ? 'selected' : ''}>(Uncle - Maternal)</option>
                  <option value="maternal-aunt" ${request.relationship === 'maternal-aunt' ? 'selected' : ''}>(Aunt - Maternal)</option>
                  <option value="grandfather" ${request.relationship === 'grandfather' ? 'selected' : ''}>(Grandfather)</option>
                  <option value="grandmother" ${request.relationship === 'grandmother' ? 'selected' : ''}>(Grandmother)</option>
                </select>
              </div>
              <div>
                <label class="font-semibold">Occupation:</label>
                <input type="text" id="edit-occupation" value="${request.occupation || ''}" class="border rounded px-2 py-1 w-full">
              </div>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Contact Information</h3>
              <div>
                <label class="font-semibold">Address:</label>
                <input type="text" id="edit-address" value="${request.address || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">City:</label>
                <input type="text" id="edit-city" value="${request.city || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">State:</label>
                <input type="text" id="edit-state" value="${request.state || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">Postal Code:</label>
                <input type="text" id="edit-postalCode" value="${request.postalCode || ''}" class="border rounded px-2 py-1 w-full">
              </div>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Emergency Contact</h3>
              <div>
                <label class="font-semibold">Name:</label>
                <input type="text" id="edit-emergencyName" value="${request.emergencyContact?.name || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">Phone:</label>
                <input type="text" id="edit-emergencyPhone" value="${request.emergencyContact?.phone || ''}" class="border rounded px-2 py-1 w-full" pattern="^03[0-9]{9}$" maxlength="11">
              </div>
              <div>
                <label class="font-semibold">Relationship:</label>
                <select id="edit-emergencyRelationship" class="border rounded px-2 py-1 w-full">
                  <option value="father" ${request.emergencyContact?.relationship === 'father' ? 'selected' : ''}>(Father)</option>
                  <option value="mother" ${request.emergencyContact?.relationship === 'mother' ? 'selected' : ''}>(Mother)</option>
                  <option value="brother" ${request.emergencyContact?.relationship === 'brother' ? 'selected' : ''}>(Brother)</option>
                  <option value="sister" ${request.emergencyContact?.relationship === 'sister' ? 'selected' : ''}>(Sister)</option>
                  <option value="uncle" ${request.emergencyContact?.relationship === 'uncle' ? 'selected' : ''}>(Uncle - Paternal)</option>
                  <option value="aunt" ${request.emergencyContact?.relationship === 'aunt' ? 'selected' : ''}>(Aunt - Paternal)</option>
                  <option value="maternal-uncle" ${request.emergencyContact?.relationship === 'maternal-uncle' ? 'selected' : ''}>(Uncle - Maternal)</option>
                  <option value="maternal-aunt" ${request.emergencyContact?.relationship === 'maternal-aunt' ? 'selected' : ''}>(Aunt - Maternal)</option>
                  <option value="grandfather" ${request.emergencyContact?.relationship === 'grandfather' ? 'selected' : ''}>(Grandfather)</option>
                  <option value="grandmother" ${request.emergencyContact?.relationship === 'grandmother' ? 'selected' : ''}>(Grandmother)</option>
                </select>
              </div>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Medical Information</h3>
              <div>
                <label class="font-semibold">Conditions:</label>
                <input type="text" id="edit-medicalConditions" value="${request.medicalInfo?.conditions || ''}" class="border rounded px-2 py-1 w-full">
              </div>
              <div>
                <label class="font-semibold">Allergies:</label>
                <input type="text" id="edit-medicalAllergies" value="${request.medicalInfo?.allergies || ''}" class="border rounded px-2 py-1 w-full">
              </div>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Additional Notes</h3>
              <textarea id="edit-additionalNotes" class="border rounded px-2 py-1 w-full">${request.additionalNotes || ''}</textarea>
            </div>
            <div class="space-y-3">
              <h3 class="font-bold text-blue-600 border-b pb-2">Date</h3>
              <input type="date" id="edit-date" class="border rounded px-2 py-1 w-full" value="${request.date ? request.date : ''}">
            </div>
          </div>
          <div class="flex justify-end space-x-2 pt-4">
            <button type="button" onclick="closeViewModal()" class="bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
          </div>
        </form>
      `;

      setTimeout(() => {
        const editGender = document.getElementById('edit-gender');
        const editGrade = document.getElementById('edit-grade');
        function handleEditGenderChange() {
          const isMale = editGender.value === 'Male';
          Array.from(editGrade.options).forEach(opt => {
            if (opt.dataset.girls === "1") {
              opt.disabled = isMale;
              if (isMale && editGrade.value === opt.value) {
                editGrade.value = "";
              }
            }
          });
        }
        editGender.addEventListener('change', handleEditGenderChange);
        handleEditGenderChange();
      }, 0);

      document.getElementById('edit-request-form').onsubmit = async function (e) {
        e.preventDefault();
        // تحقق من صحة البريد الإلكتروني
        const email = document.getElementById('edit-email').value.trim();
        if (!/^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email)) {
          alert('Parent Email must be a valid Gmail address.');
          document.getElementById('edit-email').focus();
          return;
        }
        // تحقق من صحة رقم الهاتف الباكستاني
        const phone = document.getElementById('edit-phone').value.trim();
        if (!/^03[0-9]{9}$/.test(phone)) {
          alert('Phone number must be a valid Pakistani number (e.g. 03XXXXXXXXX)');
          document.getElementById('edit-phone').focus();
          return;
        }
        // تحقق من صحة رقم الطوارئ إذا أدخل
        const emergencyPhone = document.getElementById('edit-emergencyPhone').value.trim();
        if (emergencyPhone && !/^03[0-9]{9}$/.test(emergencyPhone)) {
          alert('Emergency phone must be a valid Pakistani number (e.g. 03XXXXXXXXX)');
          document.getElementById('edit-emergencyPhone').focus();
          return;
        }
        // تحقق من صحة التاريخ
        const date = document.getElementById('edit-date').value;
        if (!date) {
          alert('Please select a date.');
          document.getElementById('edit-date').focus();
          return;
        }
        const updatedData = {
          studentName: document.getElementById('edit-studentName').value,
          gender: document.getElementById('edit-gender').value,
          parentName: document.getElementById('edit-parentName').value,
          phone: phone,
          email: email,
          grade: document.getElementById('edit-grade').value,
          dob: document.getElementById('edit-dob').value,
          previousSchool: document.getElementById('edit-previousSchool').value,
          relationship: document.getElementById('edit-relationship').value,
          occupation: document.getElementById('edit-occupation').value,
          address: document.getElementById('edit-address').value,
          city: document.getElementById('edit-city').value,
          state: document.getElementById('edit-state').value,
          postalCode: document.getElementById('edit-postalCode').value,
          emergencyContact: {
            name: document.getElementById('edit-emergencyName').value,
            phone: document.getElementById('edit-emergencyPhone').value,
            relationship: document.getElementById('edit-emergencyRelationship').value
          },
          medicalInfo: {
            conditions: document.getElementById('edit-medicalConditions').value,
            allergies: document.getElementById('edit-medicalAllergies').value
          },
          additionalNotes: document.getElementById('edit-additionalNotes').value,
          date: date
        };
        try {
          await db.collection('registrationRequests').doc(requestId).update(updatedData);
          // زر الحفظ
          const saveBtn = document.querySelector('#edit-request-form button[type="submit"]');
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
              <span class="flex items-center justify-center">
                <svg class="w-5 h-5 mr-1 text-green-200 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-green-700 font-bold">Saved!</span>
              </span>
            `;
            saveBtn.classList.remove('bg-blue-600');
            saveBtn.classList.add('bg-green-500');
          }
          setTimeout(() => {
            closeViewModal();
            loadRequests();
          }, 1200);
        } catch (error) {
          console.error('Error updating request:', error);
          alert('Failed to update the request.');
        }
      };

      document.getElementById('view-modal').classList.remove('hidden');
    }

    function deleteRequest(requestId) {
      const modal = document.getElementById('delete-confirm-modal');
      const confirmBtn = document.getElementById('confirm-delete');
      const cancelBtn = document.getElementById('cancel-delete');

      // إظهار المودال بتأثير حركي
      modal.classList.remove('scale-0');
      modal.classList.add('scale-100');

      confirmBtn.onclick = async () => {
        try {
          // إظهار أيقونة التحميل
          confirmBtn.classList.add('deleting');
          
          await db.collection('registrationRequests').doc(requestId).delete();
          
          // إظهار أيقونة النجاح
          confirmBtn.classList.remove('deleting');
          confirmBtn.classList.add('success');
          
          // انتظار لحظة ثم إغلاق المودال
          setTimeout(() => {
            modal.classList.remove('scale-100');
            modal.classList.add('scale-0');
            
            // إعادة تعيين حالة الزر بعد الإغلاق
            setTimeout(() => {
              confirmBtn.classList.remove('success');
            }, 300);
            
            loadRequests(); // تحديث القائمة
          }, 1500);

        } catch (error) {
          console.error('Error deleting request:', error);
          alert('Failed to delete the request.');
          modal.classList.remove('scale-100');
          modal.classList.add('scale-0');
        }
      };

      cancelBtn.onclick = () => {
        modal.classList.remove('scale-100');
        modal.classList.add('scale-0');
      };
    }

    function closeViewModal() {
      document.getElementById('view-modal').classList.add('hidden');
    }

    // Real-time updates
    db.collection('registrationRequests').onSnapshot(() => {
      loadRequests();
    });

    // Load messages from Firebase
    async function loadMessages() {
        try {
            const snapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
            const container = document.getElementById('messages-container');
            container.innerHTML = ''; // Clear existing messages

            if (snapshot.empty) {
                container.innerHTML = `<p class="text-center text-gray-500">No messages found.</p>`;
                return;
            }

            snapshot.forEach(doc => {
                const message = doc.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-100 p-4 rounded-lg shadow relative group';
                div.innerHTML = `
                    <div class="mb-2">
                        <span class="font-semibold text-blue-700">Sender:</span>
                        <span>${message.sender || 'Anonymous'}</span>
                    </div>
                    <div class="mb-2">
                        <span class="font-semibold text-green-700">Phone:</span>
                        <span>${message.phone || '-'}</span>
                    </div>
                    <div class="mb-2">
                        <span class="font-semibold text-purple-700">Email:</span>
                        <span>${message.email || '-'}</span>
                    </div>
                    <div class="mb-2">
                        <span class="font-semibold text-gray-700">Message:</span>
                        <span>${message.text || ''}</span>
                    </div>
                    <div>
                        <small class="text-gray-500"><strong>Sent At:</strong> ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString() : 'Unknown time'}</small>
                    </div>
                    <button onclick="deleteMessage('${doc.id}')" 
                    class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hover:bg-red-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
                `;
                container.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading messages:', error);
            document.getElementById('messages-container').innerHTML = '<p class="text-red-500">Failed to load messages.</p>';
        }
    }

    // دالة حذف الرسالة
    async function deleteMessage(messageId) {
        const modal = document.getElementById('delete-message-modal');
        const confirmBtn = document.getElementById('confirm-delete-message');
        const cancelBtn = document.getElementById('cancel-delete-message');

        // إظهار المودال
        modal.classList.remove('scale-0');
        modal.classList.add('scale-100');

        confirmBtn.onclick = async () => {
            try {
                // إظهار حالة التحميل
                confirmBtn.classList.add('deleting');
                
                await db.collection('messages').doc(messageId).delete();
                
                // إظهار حالة النجاح
                confirmBtn.innerHTML = `
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Deleted!
                    </span>
                `;
                
                // إغلاق المودال بعد 1.5 ثانية
                setTimeout(() => {
                    modal.classList.remove('scale-100');
                    modal.classList.add('scale-0');
                    loadMessages(); // إعادة تحميل الرسائل
                }, 1500);

            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete the message.');
                modal.classList.remove('scale-100');
                modal.classList.add('scale-0');
            }
        };

        cancelBtn.onclick = () => {
            modal.classList.remove('scale-100');
            modal.classList.add('scale-0');
        };
    }

    // تحميل الرسائل عند بدء الصفحة
    document.addEventListener('DOMContentLoaded', loadMessages);

    // Initial load
    loadRequests();
  </script>
  <script>
    const userRole = localStorage.getItem('userRole');
function applyRolePermissions() {
  if (userRole === 'nor' || userRole === 'mid') {
    const style = document.createElement('style');
    style.innerHTML = `
      button[onclick^="deleteRequest"],
      button[onclick^="editRequest"],
      button[onclick^="deleteMessage"] {
        display: none !important;
      }
    `;
    document.head.appendChild(style);
  }
}
document.addEventListener('DOMContentLoaded', applyRolePermissions);
  </script>
</body>
</html>
